<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>URLs Acortadas</title>
    <script>
        //dependiendo el navegador busco la referencia del objeto.
        var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB

        //indicamos el nombre y la versión
        var dataBase = indexedDB.open("finalweb", 1);


        //se ejecuta la primera vez que se crea la estructura
        //o se cambia la versión de la base de datos.
        dataBase.onupgradeneeded = function (e) {
            console.log("Creando la estructura de la tabla");

            //obteniendo la conexión activa
            active = dataBase.result;

            //creando la colección:
            //En este caso, la colección, tendrá un ID autogenerado.
            var urls = active.createObjectStore("urls", {keyPath: 'id', autoIncrement: true});

            //creando los indices. (Dado por el nombre, campo y opciones)
            urls.createIndex('por_id', 'id', {unique: false});
        };

        //El evento que se dispara una vez, lo
        dataBase.onsuccess = function (e) {
            console.log('Proceso ejecutado de forma correctamente');
        };

        dataBase.onerror = function (e) {
            console.error('Error en el proceso: ' + e.target.errorCode);
        };

        /**
         * Permite listar todos los datos digitados.
         */
        function listarDatos() {
            //por defecto si no lo indico el tipo de transacción será readonly
            var data = dataBase.result.transaction(["urls"]);
            var urls = data.objectStore("urls");
            var contador = 0;
            var urls_recuperadas = [];

            //abriendo el cursor.
            urls.openCursor().onsuccess = function (e) {
                //recuperando la posicion del cursor
                var cursor = e.target.result;
                if (cursor) {
                    contador++;
                    //recuperando el objeto.
                    urls_recuperadas.push(cursor.value);

                    //Función que permite seguir recorriendo el cursor.
                    cursor.continue();

                } else {
                    console.log("La cantidad de registros recuperados es: " + contador);
                }
            };

            //Una vez que se realiza la operación llamo la impresión.
            data.oncomplete = function () {
                imprimirTabla(urls_recuperadas);
            }

        }

        function imprimirTabla(lista) {
            //creando la tabla...
            var tabla = document.createElement("table");
            var filaTabla = tabla.insertRow();

            for (var key in lista) {
                filaTabla = tabla.insertRow();
                filaTabla.className = "table-secondary"
                filaTabla.insertCell().textContent = "" + lista[key].id;
                filaTabla.insertCell().textContent = "" + lista[key].originalURL;
            }

            document.getElementById("listar").innerHTML = "";
            document.getElementById("listar").appendChild(tabla);
        }

    </script>
</head>
<body>
<style>
    html, body {
        /*background-image: url("/img/background.jpg");*/
        background-repeat: no-repeat;
        background-size: cover;
        background-attachment: fixed;
    }
    .btn-eliminar {
        background-color: darkred !important;
        color: whitesmoke !important;
    }

    .btn-custom1 {
        background-color: dodgerblue !important;
        color: whitesmoke !important;
    }
</style>
<h1>URLs que han sido acortadas</h1>
<br/>
<button onclick="listarDatos()">Listar Datos</button>
<div id="listar"></div>
<br>
<a href="/">Volver al Inicio</a>
</body>
</html>